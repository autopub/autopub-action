name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Run all linters using pre-commit action
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: pre-commit/action@v3.0.1

  # Verify documentation matches action definition
  docs-sync:
    name: Documentation Sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          YQ_VERSION=v4.44.1
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Check inputs are documented
        run: |
          echo "Checking that all action inputs are documented in README.md..."

          # Get all input names from action.yml
          INPUTS=$(yq e '.inputs | keys | .[]' action.yml)

          MISSING=""
          for input in $INPUTS; do
            # Check if input is mentioned in README (in the inputs table)
            if ! grep -q "| \`$input\`" README.md; then
              MISSING="$MISSING $input"
            fi
          done

          if [[ -n "$MISSING" ]]; then
            echo "::error::The following inputs are not documented in README.md:$MISSING"
            exit 1
          fi
          echo "All inputs are documented"

      - name: Check outputs are documented
        run: |
          echo "Checking that all action outputs are documented in README.md..."

          # Get all output names from action.yml
          OUTPUTS=$(yq e '.outputs | keys | .[]' action.yml)

          MISSING=""
          for output in $OUTPUTS; do
            # Check if output is mentioned in README (in the outputs table)
            if ! grep -q "| \`$output\`" README.md; then
              MISSING="$MISSING $output"
            fi
          done

          if [[ -n "$MISSING" ]]; then
            echo "::error::The following outputs are not documented in README.md:$MISSING"
            exit 1
          fi
          echo "All outputs are documented"

  # Integration tests - test the action in real scenarios
  tests:
    name: Test (${{ matrix.test }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - test: check-with-release
            has-release: "true"
            release-type: patch
          - test: check-no-release
            has-release: "false"
          - test: check-fail-on-missing
            should-fail: true
          - test: invalid-command
            should-fail: true
    steps:
      - uses: actions/checkout@v4

      - name: Create mock project
        run: |
          cat > pyproject.toml << 'EOF'
          [project]
          name = "test-package"
          version = "0.1.0"

          [build-system]
          requires = ["hatchling"]
          build-backend = "hatchling.build"
          EOF

      - name: Create RELEASE.md (for release tests)
        if: matrix.test == 'check-with-release'
        run: |
          cat > RELEASE.md << 'EOF'
          ---
          release type: patch
          ---

          This is a test release for CI validation.
          EOF

      - name: Run check command
        if: matrix.test == 'check-with-release' || matrix.test == 'check-no-release'
        id: check
        uses: ./
        with:
          command: check
          autopub-version: pre-release
          upload-artifact: "false"

      - name: Run check with fail-on-missing
        if: matrix.test == 'check-fail-on-missing'
        id: check-fail
        uses: ./
        with:
          command: check
          fail-on-missing: "true"
          autopub-version: pre-release
          upload-artifact: "false"
        continue-on-error: true

      - name: Run with invalid command
        if: matrix.test == 'invalid-command'
        id: invalid
        uses: ./
        with:
          command: invalid-command
        continue-on-error: true

      - name: Verify outputs (check-with-release)
        if: matrix.test == 'check-with-release'
        run: |
          if [[ "${{ steps.check.outputs.has-release }}" != "${{ matrix.has-release }}" ]]; then
            echo "::error::Expected has-release to be '${{ matrix.has-release }}'"
            exit 1
          fi
          if [[ "${{ steps.check.outputs.release-type }}" != "${{ matrix.release-type }}" ]]; then
            echo "::error::Expected release-type to be '${{ matrix.release-type }}'"
            exit 1
          fi

      - name: Verify outputs (check-no-release)
        if: matrix.test == 'check-no-release'
        run: |
          if [[ "${{ steps.check.outputs.has-release }}" != "false" ]]; then
            echo "::error::Expected has-release to be 'false'"
            exit 1
          fi

      - name: Verify failure (fail-on-missing)
        if: matrix.test == 'check-fail-on-missing'
        run: |
          if [[ "${{ steps.check-fail.outcome }}" != "failure" ]]; then
            echo "::error::Expected action to fail with fail-on-missing=true"
            exit 1
          fi

      - name: Verify failure (invalid-command)
        if: matrix.test == 'invalid-command'
        run: |
          if [[ "${{ steps.invalid.outcome }}" != "failure" ]]; then
            echo "::error::Expected action to fail with invalid command"
            exit 1
          fi

  # All tests must pass
  all-tests:
    name: All Tests Passed
    needs: [lint, docs-sync, tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "::error::Lint job failed"
            exit 1
          fi
          if [[ "${{ needs.docs-sync.result }}" != "success" ]]; then
            echo "::error::Docs sync job failed"
            exit 1
          fi
          if [[ "${{ needs.tests.result }}" != "success" ]]; then
            echo "::error::Tests failed"
            exit 1
          fi
          echo "All tests passed!"
